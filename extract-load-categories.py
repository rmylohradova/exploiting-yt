import pandas as pd
from pprint import pprint
from googleapiclient.discovery import build
from typing import List, Optional
import os
from dotenv import load_dotenv
from sqlalchemy import create_engine

pd.set_option('display.max_columns', 40)

load_dotenv()
yt_key = os.environ['YOUTUBE_API_KEY']
userpass = os.environ['USER']
pg_port = os.environ['port']
db_name = os.environ['db']


def extract_categories():
    """google api client builds a service object for Google Youtube api
     calls instance method (videoCategories) to return list from videoCategories endpoint"""
    try:
        youtube = build('youtube', 'v3', developerKey=yt_key)
        request = youtube.videoCategories().list(
            part='snippet',
            regionCode='ua',
        )
        response = request.execute()
        cat_id: List[int] = []
        cats: List[str] = []
        n_cats = len(response['items'])
        for i in range(n_cats):
            cat_id.append(int(response['items'][i]['id']))
            cats.append(response['items'][i]['snippet']['title'])
        ctgrs_df = pd.DataFrame(list(zip(cats, cat_id)), columns=['category', 'category_id'])
        load_categories(ctgrs_df, 'genre')
    except Exception as e:
        print("Data extraction error" + str(e))


def load_categories(df, tbl):
    """Loading categories dataframe to a postgres db"""
    try:
        df.to_csv('files/categories.csv')
        engine = create_engine(f'postgresql://{userpass}@localhost:{pg_port}/{db_name}')
        df.to_sql(tbl, engine, if_exists='replace')
    except Exception as e:
        print("Data loading error" + str(e))



if __name__ == '__main__':
    extract_categories()



