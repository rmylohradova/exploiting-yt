import psycopg2
from dotenv import load_dotenv
import os
from collections import Counter


load_dotenv()
yt_key = os.environ['YOUTUBE_API_KEY']
userpass = os.environ['USER']
pg_port = os.environ['port']
db_name = os.environ['db']


def extract_category_views():
    """selecting views per category"""
    try:
        connection = psycopg2.connect(user=userpass,
                                      host="localhost",
                                      port=pg_port,
                                      database=db_name)
        cursor = connection.cursor()
        postgreSQL_select_Query = "select genre.category, sum(a.viewcount) " \
                                  "from top_per_region as a join genre " \
                                  "on a.categoryid=genre.category_id group by category;"
        cursor.execute(postgreSQL_select_Query)
        cats_views = cursor.fetchall()
        for row in cats_views:
            print('Category: ', row[0])
            print('Total views across countries: ', row[1], '\n')

    except (Exception, psycopg2.Error) as error:
        print("Error while fetching data from PostgreSQL", error)

    finally:
        if connection:
            cursor.close()
            connection.close()
            print("PostgreSQL connection is closed")

if __name__ == '__main__':
    extract_category_views()
